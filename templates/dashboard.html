{% extends 'base.html' %}

{% block content %}

<!-- SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.min.css">

<style>
 .custom-margin {
    margin-top: 50px;
    margin-bottom: 20px;
  }
  
  .bottom-squares {
    margin-top: 150px;
  }
  
  .section-title {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 30px;
    color: #808080;
  }
  
  .custom-card {
    margin-bottom: 10px;
  }
  
  .add-money-btn {
    background-color: #28a745;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 10px;
  }
  
  .add-expense-btn {
    background-color: #dc3545;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
  }

  .dialog {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
  }

  .swal2-add-money .swal2-input {
    font-size: 48px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    outline: none;
    text-align: center;
  }

  .swal2-select {
    font-size: 18px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    outline: none;
    appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
    background-position: right 10px center;
    background-size: 10px;
  }

  .swal2-popup .swal2-title {
    font-size: 20px;
    font-weight: bold;
  }

  .btn-focus:focus {
    outline: none;
  }

</style>

<div class="container custom-margin">

  <div class="row mt-5">
    <!-- Square 1 -->
    <div class="col-md-6 col-lg-6 mb-3">
      <div class="card border-0 wallet-card" style="background-color: #eeeeee; height: 150px;">
        <div class="card-body">
          <h4 class="card-title">Current Balance</h4>
          <!-- Update the ID to match "balance" instead of "current-balance" -->
          <h2 id="balance" style="font-size: 36px; font-weight: bold; text-align: center;">Loading...</h2>
        </div>
      </div>
    </div>
    <!-- Square 2 -->
    <div class="col-md-6 col-lg-6 mb-3">
      <div class="card border-0 wallet-card" style="background-color: #eeeeee; height: 150px;">
        <div class="card-body">
          <!-- Square 2 content -->
        </div>
      </div>
    </div>
  </div>
  
  <div class="row bottom-squares">
    <div class="col-12">
      <h2 class="section-title">Your performance</h2>
    </div>
    <!-- Square 3 -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card border-0 wallet-card" style="background-color: #6610F2; height: 200px;">
        <div class="card-body">
          <!-- Square 3 content -->
        </div>
      </div>
    </div>
    <!-- Square 4 -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card border-0 wallet-card" style="background-color: #6C757D; height: 200px;">
        <div class="card-body">
          <!-- Square 4 content -->
        </div>
      </div>
    </div>
    <!-- Square 5 -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card border-0 wallet-card" style="background-color: #FD7E14; height: 200px;">
        <div class="card-body">
          <!-- Square 5 content -->
        </div>
      </div>
    </div>
    <div class="col-12 text-center">
      <button class="add-money-btn btn-focus" onclick="showAddMoneyDialog()">Add money</button>
      <button class="add-expense-btn btn-focus" onclick="fetchAndShowAddExpenseDialog()">Add expense</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.all.min.js"></script>  
  <script>
  
    // Function to fetch the current balance for the logged-in user from the server
    function updateBalance() {
      fetch('/get_balance', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            const formattedBalance = formatAmountWithCommas(data.balance.toFixed(2));
            document.getElementById('balance').innerText = '$' + formattedBalance;
          } else {
            console.error('Error fetching balance:', data.message);
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }

    // Call the updateBalance function to initially fetch and display the balance
    updateBalance();

    // Function to display the pop-up dialog using SweetAlert
    function showAddMoneyDialog() {
      Swal.fire({
        title: 'Add money',
        input: 'text',
        inputAttributes: {
          required: true,
          type: 'text',
          pattern: '^\\d{1,3}(,\\d{3})*(\\.\\d{2})?$',
          // pattern ensures valid format
        },
        showCancelButton: true,
        confirmButtonText: 'Add',
        cancelButtonText: 'Cancel',
        inputValue: '0.00', // Initial value
        customClass: {
          container: 'swal2-add-money',
        },
        didOpen: () => {
          const amountInput = Swal.getInput();
          amountInput.addEventListener('input', formatAmountInput);
          amountInput.addEventListener('keydown', restrictAmountLength);
        },
        willClose: () => {
          const amountInput = Swal.getInput();
          amountInput.removeEventListener('input', formatAmountInput);
          amountInput.removeEventListener('keydown', restrictAmountLength);
        },
      }).then((result) => {
        if (result.isConfirmed) {
          const enteredAmount = result.value;
          const formattedAmount = formatAmountWithCommas(enteredAmount);
          handleAddButtonClick(formattedAmount);
        }
      });
    }
  
    // Function to format the amount as the user types
    function formatAmountInput() {
      const amountInput = Swal.getInput();
      const enteredAmount = amountInput.value;
  
      if (enteredAmount.trim() === '') {
        return;
      }
  
      const numericValue = enteredAmount.replace(/[^\d]/g, '');
      const formattedAmount = (numericValue / 100).toFixed(2);
      amountInput.value = formatAmountWithCommas(formattedAmount);
    }
    
    // Function to add commas for thousands separator
    function formatAmountWithCommas(amount) {
      const parts = amount.split('.');
      const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return parts.length === 1 ? integerPart : integerPart + '.' + parts[1];
    }

    // Function to restrict the amount input length to 9 characters
    function restrictAmountLength(event) {
      const amountInput = event.target;
      const numericValue = amountInput.value.replace(/[^\d]/g, '');

      if (numericValue.length >= 9 && event.keyCode !== 8 /* Backspace key */) {
        event.preventDefault();
    }
    }

    // Function to handle the "Add" button click and save the amount to the server
    function handleAddButtonClick(amount) {
      const amountInput = amount;

      if (!amountInput || amountInput <= 0) {
        Swal.fire('Error', 'Please enter a valid amount.', 'error');
        return;
      }

      fetch('/add_money', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ amount: amountInput }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            Swal.fire('Success', 'Amount added successfully.', 'success');
            updateBalance(); // Update the displayed balance after adding the amount
          } else {
            Swal.fire('Error', data.message, 'error');
          }
        })
        .catch((error) => {
          Swal.fire('Error', 'An error occurred while adding the amount.', 'error');
          console.error('Error:', error);
        });
    }

    function closeAddMoneyDialog() {
      const addMoneyDialog = document.getElementById('add-money-dialog');
      addMoneyDialog.style.display = 'none';
    }

    // Function to handle the "Add Expense" button click and save the expense to the server
    function handleAddExpenseClick() {
      const amountInput = document.getElementById('expense-amount-input').value;
      const nameInput = document.getElementById('name-input').value;
      const typeInput = document.getElementById('expense-type-input').value;

      if (!amountInput || amountInput <= 0 || !nameInput || !typeInput) {
        Swal.fire('Error', 'Please enter a valid amount, name, and type.', 'error');
        return;
      }

      fetch('/add_expense', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          amount: amountInput,
          name: nameInput,
          type: typeInput,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            Swal.fire('Success', 'Expense added successfully.', 'success');
            // Perform any additional actions after adding the expense
          } else {
            Swal.fire('Error', data.message, 'error');
          }
        })
        .catch((error) => {
          Swal.fire('Error', 'An error occurred while adding the expense.', 'error');
          console.error('Error:', error);
        });
    }

    // Function to show the "Add Expense" dialog
    function showAddExpenseDialog() {
          Swal.fire({
            title: 'Add Expense',
            html:
              '<input id="expense-amount-input" type="text" placeholder="Amount" required pattern="^\\d{1,3}(,\\d{3})*(\\.\\d{2})?$" class="swal2-input">' +
              '<input id="name-input" type="text" placeholder="Name" required class="swal2-input">' +
              '<select id="expense-type-input" required class="swal2-select">' +
              '<option value="">Select type</option>' +
              '</select>',
            showCancelButton: true,
            confirmButtonText: 'Add',
            cancelButtonText: 'Cancel',
            preConfirm: () => {
              const amountInput = document.getElementById('expense-amount-input').value;
              const nameInput = document.getElementById('name-input').value;
              const typeInput = document.getElementById('expense-type-input').value;
              return { amountInput, nameInput, typeInput };
            },
          }).then((result) => {
            if (result.isConfirmed) {
              const { amountInput, nameInput, typeInput } = result.value;
              handleAddExpenseClick(amountInput, nameInput, typeInput);
            }
          });
    }

    // Function to fetch the expense types from the server and show the "Add Expense" dialog
    function fetchAndShowAddExpenseDialog() {
      fetch('/get_expense_types', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Populate the dropdown options with the retrieved expense types
            const names = data.names;

            const expenseTypeInput = document.getElementById('expense-type-input');
            names.forEach((type) => {
              const option = document.createElement('option');
              option.value = type;
              option.textContent = type;

              expenseTypeInput.appendChild(option);

            });

            // Show the "Add Expense" dialog with the updated options
            showAddExpenseDialog();

          } else {
            console.error('Error fetching expense types:', data.message);
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }

    // Function to close the "Add Expense" dialog
    function closeAddExpenseDialog() {
      Swal.close();
    }

  </script>
  
  <!-- The Add Money Dialog -->
  <div id="add-money-dialog" class="dialog">
    <div class="dialog-content">
      <input type="text" id="amount-input" required />
      <button onclick="handleAddButtonClick()">Add</button>
      <button onclick="closeAddMoneyDialog()">Cancel</button>
    </div>
  </div>

<!-- The Add Expense Dialog -->
<div id="add-expense-dialog" class="dialog">
  <div class="dialog-content">
    <input id="expense-amount-input" type="text" placeholder="Amount" required pattern="^\d{1,3}(,\d{3})*(\.\d{2})?$" class="swal2-input">
    <input id="name-input" type="text" placeholder="Name" required class="swal2-input">
    <select id="expense-type-input" required class="swal2-select">
      <!-- The types will be populated dynamically from the backend using JavaScript -->
    </select>
    <button onclick="handleAddExpenseClick()">Add</button>
    <button onclick="closeAddExpenseDialog()">Cancel</button>
  </div>
</div>

{% endblock %}