{% extends 'base.html' %}

{% block content %}

<style>
  .delete-wallet-btn,
  .delete-user-btn,
  .add-user-btn {
    background-color: #ff0000;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 10px;
  }

  .add-user-btn {
    background-color: #2b82c9;
    padding: 5px 10px;
  }

  .btn-focus:focus {
    outline: none;
  }

  .selected {
    background-color: #ffd4d4;
  }

  .table-striped tr:nth-child(odd) {
    background-color: #f8f9fa; /* Light grey color for odd rows */
  }

</style>

<div class="container">
  <!-- Wallet Details -->
  <h2 class="mt-5">{{ wallet.wallet_name }}</h2>
  {% if is_owner %}
    <button class="delete-wallet-btn btn-focus" onclick="showDeleteWalletConfirmation('{{ wallet.wallet_id }}')">Delete wallet</button>
  {% endif %}
  
  <!-- Filter Menu Bar -->
  <div class="row mt-4">
    <div class="col-9">
      <!-- Expenses Table -->
      <div class="table-responsive">
        <table id="expensesTable" class="table mt-2 table-striped">
          <thead>
            <tr>
              <th onclick="sortExpenses('name')" style="cursor: pointer;">Name <span id="nameSortIcon"></span></th>
              <th onclick="sortExpenses('amount')" style="cursor: pointer;">Amount <span id="amountSortIcon"></span></th>
              <th onclick="sortExpenses('type')" style="cursor: pointer;">Type <span id="typeSortIcon"></span></th>
              <th onclick="sortExpenses('date')" style="cursor: pointer;">Date <span id="dateSortIcon"></span></th>
              <th onclick="sortExpenses('user')" style="cursor: pointer;">User <span id="userSortIcon"></span></th>
            </tr>
          </thead>          
          <tbody id="expensesTableBody">
            {% for expense in expenses_list %}
              <tr data-expense-id="{{ expense.expense_id }}" onclick="handleExpenseClick(event, '{{ expense.expense_id }}')">
                <td>{{ expense.expense_name }}</td>
                <td>{{ expense.expense_amount }}</td>
                <td>{{ expense.type_name }}</td>
                <td>{{ expense.expense_date }}</td>
                <td>{{ expense.user_email }}</td>
              </tr>            
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% if is_owner and wallet_name != "Main" %}
      <div class="col-3">
        <div class="card-body d-flex flex-column justify-content-between align-items-center h-100">
          <h5 class="card-title mb-0">Users in this wallet</h5>
          <button class="add-user-btn btn-focus mt-2" onclick="showAddUserDialog()">Add user</button>
          <div class="list-group flex-grow-1 mt-2">
            {% if shared_users %}
              {% for shared_user in shared_users %}
                <div class="user-item d-flex justify-content-between align-items-center">
                  <div>{{ shared_user }}</div>
                  {% if is_owner %}
                    <button class="delete-user-btn btn-focus" onclick="showDeleteUserConfirmation('{{ shared_user }}')">Delete</button>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="user-item d-flex justify-content-between align-items-center">This wallet is not shared</p>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
                
<!-- Add User Dialog -->
<div class="modal fade" id="addUserDialog" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add user</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="email" id="userEmail" class="form-control" placeholder="Enter email">
      </div>
      <div class="modal-footer">
        <button type="button" onclick="addUser()">Add</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>

<script>
 
    function showDeleteWalletConfirmation(wallet_id) {
      
      Swal.fire({
        title: 'Delete Wallet',
        text: 'Are you sure you want to delete this wallet?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Continue',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          deleteWallet(wallet_id);
        }
      });
    }

    function deleteWallet(wallet_id) {
  // Send the request to delete the wallet
  fetch('/delete_wallet', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      wallet_id: wallet_id
    })
  })
    .then(response => response.json())
    .then(data => {
      if (data.message === 'Wallet deleted successfully') {
        // Show the SweetAlert success message
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: data.message
        }).then(() => {
          // Redirect to /wallets after a slight delay (e.g., 1 second)
          setTimeout(() => {
            window.location.href = '/wallets';
          }, 10);
        });
      } else {
        // Display an error message using SweetAlert
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message
        });
      }
    })
    .catch(error => {
      console.log('Error:', error);
    });
}

function showDeleteUserConfirmation(userEmail) {
    Swal.fire({
      title: 'Delete User',
      text: `Are you sure you want to remove ${userEmail}?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Remove',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        deleteUser(userEmail);
      }
    });
  }

  function deleteUser(userEmail) {
    // Send the request to delete the user from the wallet
    fetch('/delete_user', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        wallet_id: '{{ wallet.wallet_id }}',
        user_email: userEmail
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.message === 'User deleted successfully') {
          // Refresh the page or update the user list
          window.location.reload();
        } else {
          // Display an error message using SweetAlert
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message
          });
        }
      })
      .catch(error => {
        console.log('Error:', error);
      });
  }

    function showAddUserDialog() {
      Swal.fire({
        title: 'Add User',
        html: '<input type="email" id="swalUserEmail" class="form-control" placeholder="Enter email">',
        showCancelButton: true,
        confirmButtonText: 'Add',
        cancelButtonText: 'Cancel',
        preConfirm: function() {
          const userEmail = document.getElementById('swalUserEmail').value;
          const wallet_id = '{{ wallet_id }}';

        // Check if the email field is empty
        if (userEmail.trim() === '') {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Email is required'
          });
          return false; // Prevent the dialog from closing when validation fails
        }

        // Send the request to add the user
        return fetch('/add_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_email: userEmail,
            wallet_id: wallet_id
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.message === 'User added successfully') {
            // Show a success message
            Swal.fire({
              icon: 'success',
              title: 'Success',
              text: 'User added successfully.'
            }).then(function() {
              // Refresh the page or update the user list
              window.location.reload();
            });
          } else {
            // Show an error message
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message
            });
          }
        })
        .catch(error => {
          console.log('Error:', error);
        });
      }
    });
  }

  // Function to fetch and populate expenses
  function fetchExpenses(walletId) {
  fetch(`/get_expenses_list/${walletId}`, {
    method: 'GET',
    credentials: 'include'
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const expensesTableBody = document.getElementById('expensesTableBody');
        expensesTableBody.innerHTML = ''; // Clear existing rows

        // Populate the expenses table with fetched data
        data.expenses_list.forEach(expense => {
          const row = expensesTableBody.insertRow();
          row.innerHTML = `
            <td>${expense.name}</td> <!-- User's name -->
            <td>${format_amount(expense.amount)}</td> <!-- Amount -->
            <td>${expense.type}</td> <!-- Type -->
            <td>${expense.date}</td> <!-- Date -->
            <td>${expense.user}</td> <!-- User's email -->
          `;
        });
      } else {
        console.error(data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
}

// Call the fetchExpenses function when the page loads
document.addEventListener('DOMContentLoaded', function () {
  const walletId = '{{ wallet.wallet_id }}';
  
  fetchExpenses(walletId);

});

function format_amount(amount) {
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        return formatter.format(amount);
}

// Array to store selected expense IDs
const selectedExpenses = [];

// Function to toggle selection of an expense
function toggleExpenseSelection(expenseId) {
    const index = selectedExpenses.indexOf(expenseId);
    if (index === -1) {
      selectedExpenses.push(expenseId);
    } else {
      selectedExpenses.splice(index, 1);
    }
    updateExpenseSelectionUI();
  }

  // Function to update the UI based on selected expenses
  function updateExpenseSelectionUI() {
    const expensesRows = document.querySelectorAll('#expensesTableBody tr');
    expensesRows.forEach(row => {
      const expenseId = row.getAttribute('data-expense-id');
      if (selectedExpenses.includes(expenseId)) {
        row.classList.add('selected');
      } else {
        row.classList.remove('selected');
      }
    });
  }

  // Function to handle Ctrl key press and clicking on expenses
  function handleExpenseClick(event, expenseId) {
    console.log('Expense clicked:', expenseId);
    if (event.ctrlKey || event.metaKey) {
      event.preventDefault();
      console.log('Control key pressed');
      toggleExpenseSelection(expenseId);
    }
  }

let sortStatus = {};

// Define the getSortIndex function
function getSortIndex(sortKey) {
  const headers = ['name', 'amount', 'type', 'date', 'user'];
  return headers.indexOf(sortKey);
}

function sortExpenses(sortKey) {
  const expensesRows = Array.from(document.querySelectorAll('#expensesTableBody tr'));
  const headers = ['name', 'amount', 'type', 'date', 'user'];

  // Reset sort icons for all columns except the current one
  headers.forEach(header => {
    if (header !== sortKey) {
      const otherSortIcon = document.getElementById(`${header}SortIcon`);
      otherSortIcon.innerHTML = '';
    }
  });

  const sortIcon = document.getElementById(`${sortKey}SortIcon`);

  if (sortStatus[sortKey] === 'asc') {
    sortStatus[sortKey] = 'desc'; // Toggle to descending order
    sortIcon.innerHTML = '▼'; // Downward-pointing triangle for descending
  } else {
    sortStatus[sortKey] = 'asc'; // Toggle to ascending order
    sortIcon.innerHTML = '▲'; // Upward-pointing triangle for ascending
  }

  expensesRows.sort((a, b) => {
    const aData = a.querySelector(`td:nth-child(${getSortIndex(sortKey) + 1})`).textContent;
    const bData = b.querySelector(`td:nth-child(${getSortIndex(sortKey) + 1})`).textContent;

    if (sortKey === 'amount') {
      const aValue = parseFloat(aData.replace(/[^0-9.-]+/g, ""));
      const bValue = parseFloat(bData.replace(/[^0-9.-]+/g, ""));

      // Sort in ascending or descending order based on sort status
      if (sortStatus[sortKey] === 'asc') {
        return aValue - bValue;
      } else {
        return bValue - aValue;
      }
    } else {
      // For non-numeric columns, perform string-based sorting
      if (sortStatus[sortKey] === 'asc') {
        return aData.localeCompare(bData);
      } else {
        return bData.localeCompare(aData);
      }
    }
  });

  expensesTableBody.innerHTML = ''; // Clear the existing table body

  expensesRows.forEach(row => {
    expensesTableBody.appendChild(row); // Append sorted rows back to the table body
  });
}

</script>
</div>
{% endblock %}