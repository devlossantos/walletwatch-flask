{% extends 'base.html' %}

{% block content %}

<style>

.delete-wallet-btn {
  background-color: #ff0000;
  color: #fff;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  padding: 10px 20px;
  margin-right: 10px;
}

.btn-focus:focus {
    outline: none;
}

.delete-user-btn {
  background-color: #ff0000;
  color: #fff;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-right: 10px;
}

.add-user-btn {
  background-color: #2b82c9;
  color: #fff;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  padding: 5px 10px;
  margin-right: 10px;
}

</style>

<div class="container">
    <!-- Wallet Details -->
    <h2 class="mt-5">{{ wallet.wallet_name }}</h2>
    {% if is_owner %}
    <button class="delete-wallet-btn btn-focus" onclick="showDeleteWalletConfirmation('{{ wallet.wallet_id }}')">Delete wallet</button>
    {% endif %}
    <!-- Filter Menu Bar -->
    <div class="row mt-4">
      <div class="col-9">
        <!-- Expenses Table -->
        <div class="table-responsive">
          <table id="expensesTable" class="table mt-2">
            <thead>
              <tr>
                {% if is_owner %}
                <th><input type="checkbox" id="selectAllExpenses" onclick="selectAllExpenses()"></th>
                {% else %}
                <th></th>
                {% endif %}
                <th onclick="sortExpenses('name')">Name</th>
                <th onclick="sortExpenses('amount')">Amount</th>
                <th onclick="sortExpenses('type')">Type</th>
                <th onclick="sortExpenses('date')">Date</th>
                <th onclick="sortExpenses('user')">User</th>
              </tr>
            </thead>
            <tbody id="expensesTableBody">
              {% for expense in expenses_list %}
              <tr>
                {% if is_owner %}
                <td><input type="checkbox" class="expenseCheckbox" data-expense-id="{{ expense.expense_id }}"></td>
                {% else %}
                <td></td>
                {% endif %}
                <td>{{ expense.expense_name }}</td>
                <td>{{ expense.expense_amount }}</td>
                <td>{{ expense.type_name }}</td>
                <td>{{ expense.expense_date }}</td>
                <td>{{ expense.user_email }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>

          <button class="delete-wallet-btn btn-focus" id="deleteExpensesBtn" style="display: none;" onclick="deleteSelectedExpenses()">Delete expense(s)</button>

        </div>
      </div>

      <div class="col-3">
        <div class="card-body d-flex justify-content-between align-items-center">
          <!-- Users Banner -->
          <h5 class="card-title mb-0">Users in this wallet</h5>
          <div>
              {% if is_owner %}
              <button class="add-user-btn btn-focus" onclick="showAddUserDialog()">Add user</button>
              {% endif %}
          </div>
      </div>
      <div class="list-group flex-grow-1">
        {% if shared_users %}
          {% for shared_user in shared_users %}
            <div class="user-item d-flex justify-content-between align-items-center">
              <div>{{ shared_user }}</div>
              {% if is_owner %}
              <button class="delete-user-btn btn-focus" onclick="showDeleteUserConfirmation('{{ shared_user }}')">Delete</button>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p class="user-item d-flex justify-content-between align-items-center">This wallet is not shared</p>
        {% endif %}
      </div>   
              
<!-- Add User Dialog -->
<div class="modal fade" id="addUserDialog" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add user</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="email" id="userEmail" class="form-control" placeholder="Enter email">
      </div>
      <div class="modal-footer">
        <button type="button" onclick="addUser()">Add</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>

    <script>
    
    function showDeleteWalletConfirmation(wallet_id) {
      
      Swal.fire({
        title: 'Delete Wallet',
        text: 'Are you sure you want to delete this wallet?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Continue',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          deleteWallet(wallet_id);
        }
      });
    }

    function deleteWallet(wallet_id) {
  // Send the request to delete the wallet
  fetch('/delete_wallet', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      wallet_id: wallet_id
    })
  })
    .then(response => response.json())
    .then(data => {
      if (data.message === 'Wallet deleted successfully') {
        // Show the SweetAlert success message
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: data.message
        }).then(() => {
          // Redirect to /wallets after a slight delay (e.g., 1 second)
          setTimeout(() => {
            window.location.href = '/wallets';
          }, 10);
        });
      } else {
        // Display an error message using SweetAlert
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message
        });
      }
    })
    .catch(error => {
      console.log('Error:', error);
    });
}

function showDeleteUserConfirmation(userEmail) {
    Swal.fire({
      title: 'Delete User',
      text: `Are you sure you want to remove ${userEmail}?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Remove',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        deleteUser(userEmail);
      }
    });
  }

  function deleteUser(userEmail) {
    // Send the request to delete the user from the wallet
    fetch('/delete_user', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        wallet_id: '{{ wallet.wallet_id }}',
        user_email: userEmail
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.message === 'User deleted successfully') {
          // Refresh the page or update the user list
          window.location.reload();
        } else {
          // Display an error message using SweetAlert
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message
          });
        }
      })
      .catch(error => {
        console.log('Error:', error);
      });
  }

    function showAddUserDialog() {
      Swal.fire({
        title: 'Add User',
        html: '<input type="email" id="swalUserEmail" class="form-control" placeholder="Enter email">',
        showCancelButton: true,
        confirmButtonText: 'Add',
        cancelButtonText: 'Cancel',
        preConfirm: function() {
          const userEmail = document.getElementById('swalUserEmail').value;
          const wallet_id = '{{ wallet_id }}';

        // Check if the email field is empty
        if (userEmail.trim() === '') {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Email is required'
          });
          return false; // Prevent the dialog from closing when validation fails
        }

        // Send the request to add the user
        return fetch('/add_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_email: userEmail,
            wallet_id: wallet_id
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.message === 'User added successfully') {
            // Show a success message
            Swal.fire({
              icon: 'success',
              title: 'Success',
              text: 'User added successfully.'
            }).then(function() {
              // Refresh the page or update the user list
              window.location.reload();
            });
          } else {
            // Show an error message
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message
            });
          }
        })
        .catch(error => {
          console.log('Error:', error);
        });
      }
    });
  }

  // Function to fetch and populate expenses
  function fetchExpenses(walletId) {
  fetch(`/get_expenses_list/${walletId}`, {
    method: 'GET',
    credentials: 'include' // Include cookies for authentication
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const expensesTableBody = document.getElementById('expensesTableBody');
        expensesTableBody.innerHTML = ''; // Clear existing rows

        // Populate the expenses table with fetched data
        data.expenses_list.forEach(expense => {
          const row = expensesTableBody.insertRow();
          row.innerHTML = `
            <td><input type="checkbox" class="expenseCheckbox"></td>
            <td>${expense.name}</td> <!-- User's name -->
            <td>${format_amount(expense.amount)}</td> <!-- Amount -->
            <td>${expense.type}</td> <!-- Type -->
            <td>${expense.date}</td> <!-- Date -->
            <td>${expense.user}</td> <!-- User's email -->
          `;

          // Get the newly created checkbox element
          const checkbox = row.querySelector('.expenseCheckbox');

          // Attach an event listener to the checkbox
          checkbox.addEventListener('click', updateDeleteButtonState);
        });
      } else {
        console.error(data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
}

// Call the fetchExpenses function when the page loads
document.addEventListener('DOMContentLoaded', function () {

  // Fetch and display expenses for the current wallet
  const walletId = '{{ wallet.wallet_id }}';
  fetchExpenses(walletId);
});

function format_amount(amount) {
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        return formatter.format(amount);
}

function selectAllExpenses() {

    const selectAllCheckbox = document.getElementById('selectAllExpenses');
    const expenseCheckboxes = document.querySelectorAll('.expenseCheckbox');

    const selectAll = selectAllCheckbox.checked;

    expenseCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
    });

    updateDeleteButtonState();
}

function updateDeleteButtonState() {
    const expenseCheckboxes = document.querySelectorAll('.expenseCheckbox');
    const deleteExpensesBtn = document.getElementById('deleteExpensesBtn');
    const selectAllCheckbox = document.getElementById('selectAllExpenses');

    let atLeastOneSelected = false;

    expenseCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            atLeastOneSelected = true;
            return;
        }
    });

    // Update the state of the "Select All" checkbox
    selectAllCheckbox.checked = atLeastOneSelected;

    if (atLeastOneSelected) {
        deleteExpensesBtn.style.display = 'block';
    } else {
        deleteExpensesBtn.style.display = 'none';
    }
}

    </script>
</div>
{% endblock %}